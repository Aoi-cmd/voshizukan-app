<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ©ã‚¤ãƒãƒ¼è©³ç´°</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="liver-page">
  <header class="header">
    <h1 id="liverName">ãƒ©ã‚¤ãƒãƒ¼è©³ç´°</h1>
    <p id="channelUrlDisplay"></p>
  </header>

  <section class="info">
    <p><strong>å‡ºä¼šã„æ—¥:</strong> <span id="startDate"></span></p>
    <p><strong>ãƒ¡ãƒ¢</strong> <span id="relationship"></span></p>
  </section>

  <section class="add-log">
    <h2 class="log-title">å¥½ããªé…ä¿¡ã€å‹•ç”»ã¯ã“ã“ã¸</h2>
    <input type="text" id="logTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
    <input type="datetime-local" id="logViewedAt">
    <textarea id="logMemo" placeholder="æ„Ÿæƒ³ãƒ¡ãƒ¢"></textarea>
    <textarea id="logTimestamp" placeholder="ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ¡ãƒ¢"></textarea>
    <input type="text" id="logVideoUrl" placeholder="URL">
    <button id="addLogBtn" class="button">è¿½åŠ </button>
  </section>

  <!-- ğŸ”æ¤œç´¢ï¼†ä¸¦ã³æ›¿ãˆ UI -->
  <section class="log-controls">
    <div class="log-controls-group">
      <label for="searchInput">ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢</label><br>
      <input type="text" id="searchInput" class="log-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã§æ¤œç´¢">
    </div>

    <div class="log-controls-group">
      <label for="sortSelect">ä¸¦ã³æ›¿ãˆ</label><br>
      <select id="sortSelect" class="log-select">
        <option value="desc">è¦–è´æ—¥æ™‚ï¼ˆæ–°ã—ã„é †ï¼‰</option>
        <option value="asc">è¦–è´æ—¥æ™‚ï¼ˆå¤ã„é †ï¼‰</option>
      </select>
    </div>
  </section>

  <section class="logs">
    <h2>é…ä¿¡ãƒ»å‹•ç”»</h2>
    <div id="logList"></div>
  </section>

  <div id="notification" class="notification"></div>

  <footer class="footer">
    <button class="button" onclick="location.href='index.html'">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</button>
  </footer>

  <script>
    const params = new URLSearchParams(location.search);
    const liverId = Number(params.get('id'));
    const liver = JSON.parse(localStorage.getItem('livers') || '[]').find(l => l.id === liverId);

    if (!liver) {
      alert('ãƒ©ã‚¤ãƒãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      location.href = 'index.html';
    }

    document.getElementById('liverName').textContent = liver.name;
    document.getElementById('channelUrlDisplay').innerHTML = `<a href="${liver.channelUrl}" target="_blank">ãƒãƒ£ãƒ³ãƒãƒ«ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>`;
    document.getElementById('startDate').textContent = liver.startDate || 'æœªè¨­å®š';
    document.getElementById('relationship').textContent = liver.relationship || 'ãªã—';

    const logListEl = document.getElementById('logList');
    const logsKey = `logs_${liver.id}`;

    function renderLogs() {
      logListEl.innerHTML = '';
      let logs = JSON.parse(localStorage.getItem(logsKey) || '[]');
      const searchKeyword = document.getElementById('searchInput').value.trim().toLowerCase();
      const sortOrder = document.getElementById('sortSelect').value;

      if (searchKeyword) {
        logs = logs.filter(log => log.title.toLowerCase().includes(searchKeyword));
      }

      logs.sort((a, b) => {
        const dateA = new Date(a.viewedAt || 0);
        const dateB = new Date(b.viewedAt || 0);
        return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
      });

      logs.forEach((log, index) => {
        const div = document.createElement('div');
        div.classList.add('card');
        div.innerHTML = `
          <input type="text" value="${log.title}" id="title_${index}" class="input-log">
          <input type="datetime-local" value="${log.viewedAt}" id="viewedAt_${index}" class="input-log">
          <textarea id="memo_${index}" class="input-log">${log.memo}</textarea>
          <textarea id="timestamp_${index}" class="input-log">${log.timestamp}</textarea>
          <input type="text" value="${log.videoUrl || ''}" id="videoUrl_${index}" class="input-log" placeholder="å‹•ç”»URLï¼ˆä»»æ„ï¼‰">
          ${log.videoUrl ? `<p><a href="${log.videoUrl}" target="_blank">å‹•ç”»ã‚’è¦‹ã‚‹</a></p>` : ''}
          <button class="button" onclick="saveLog(${index})">ä¿å­˜</button>
          <button class="button deleteBtn" onclick="deleteLog(${index})">å‰Šé™¤</button>
        `;
        logListEl.appendChild(div);
      });
    }

    function saveLog(index) {
      let logs = JSON.parse(localStorage.getItem(logsKey) || '[]');
      logs[index].title = document.getElementById(`title_${index}`).value;
      logs[index].viewedAt = document.getElementById(`viewedAt_${index}`).value;
      logs[index].memo = document.getElementById(`memo_${index}`).value;
      logs[index].timestamp = document.getElementById(`timestamp_${index}`).value;
      logs[index].videoUrl = document.getElementById(`videoUrl_${index}`).value;
      localStorage.setItem(logsKey, JSON.stringify(logs));
      renderLogs();
      showNotification("ä¿å­˜ã—ã¾ã—ãŸ âœ…");
    }

    function deleteLog(index) {
      let logs = JSON.parse(localStorage.getItem(logsKey) || '[]');
      logs.splice(index, 1);
      localStorage.setItem(logsKey, JSON.stringify(logs));
      renderLogs();
      showNotification("å‰Šé™¤ã—ã¾ã—ãŸ ğŸ—‘");
    }

    document.getElementById('addLogBtn').addEventListener('click', () => {
      const title = document.getElementById('logTitle').value;
      const viewedAt = document.getElementById('logViewedAt').value;
      const memo = document.getElementById('logMemo').value;
      const timestamp = document.getElementById('logTimestamp').value;
      const videoUrl = document.getElementById('logVideoUrl').value;

      if (!title || !viewedAt) {
        alert("é…ä¿¡ã‚¿ã‚¤ãƒˆãƒ«ã¨è¦–è´æ—¥æ™‚ã¯å¿…é ˆã§ã™");
        return;
      }

      const newLog = { title, viewedAt, memo, timestamp, videoUrl };
      const logs = JSON.parse(localStorage.getItem(logsKey) || '[]');
      logs.push(newLog);
      localStorage.setItem(logsKey, JSON.stringify(logs));

      document.getElementById('logTitle').value = '';
      document.getElementById('logViewedAt').value = '';
      document.getElementById('logMemo').value = '';
      document.getElementById('logTimestamp').value = '';
      document.getElementById('logVideoUrl').value = '';

      renderLogs();
      showNotification("é…ä¿¡ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸ âœ…");
    });

    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 2000);
    }

    document.getElementById('searchInput').addEventListener('input', renderLogs);
    document.getElementById('sortSelect').addEventListener('change', renderLogs);

    renderLogs();
  </script>
</body>
</html>
